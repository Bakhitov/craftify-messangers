#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ 002_remove_current_api_key.sql
# –£–¥–∞–ª—è–µ—Ç –ø–æ–ª–µ current_api_key –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç api_key —Ä–∞–≤–Ω—ã–º instance_id

set -e

echo "üîÑ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ 002: –£–¥–∞–ª–µ–Ω–∏–µ current_api_key"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ -z "$DATABASE_URL" ]; then
    echo "‚ùå –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è DATABASE_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"
    echo "üí° –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é: export DATABASE_URL='postgresql://user:password@host:port/database'"
    exit 1
fi

echo "üìä –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö: $DATABASE_URL"

# –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏—é
echo "üîß –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏..."
psql "$DATABASE_URL" -f "$(dirname "$0")/../db/migrations/versions/002_remove_current_api_key.sql"

if [ $? -eq 0 ]; then
    echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è 002 —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞!"
    echo ""
    echo "üìã –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:"
    echo "  - –£–¥–∞–ª–µ–Ω–æ –ø–æ–ª–µ current_api_key –∏–∑ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü"
    echo "  - –û–±–Ω–æ–≤–ª–µ–Ω—ã api_key —Ä–∞–≤–Ω—ã–º–∏ instance_id –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π"
    echo "  - –û–±–Ω–æ–≤–ª–µ–Ω—ã api_key_generated_at –¥–ª—è –ø—É—Å—Ç—ã—Ö –∑–∞–ø–∏—Å–µ–π"
    echo ""
    echo "üöÄ –¢–µ–ø–µ—Ä—å API –∫–ª—é—á–∏ –≤—Å–µ–≥–¥–∞ —Ä–∞–≤–Ω—ã instance_id"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–∏"
    exit 1
fi 